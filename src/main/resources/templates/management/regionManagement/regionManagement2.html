<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>区划管理</title>
    <script th:src="@{/webjars/jquery/3.5.1/jquery.js}"></script>
    <!--layui-->
    <script type="text/javascript" th:src="@{/webjars/layui/2.6.8/layui.js}"></script>
    <link rel="stylesheet" th:href="@{/webjars/layui/2.6.8/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/layuiTable.css}">
    <link rel="stylesheet" th:href="@{/css/layuiLayer.css}">
    <!--EasyUI_Tree 样式-->
    <script type="text/javascript" th:src="@{/js/jquery-easyui-1.9.4/jquery.easyui.min.js}"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/js/jquery-easyui-1.9.4/themes/default/easyui.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/js/jquery-easyui-1.9.4/themes/icon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/js/jquery-easyui-1.9.4/themes/gray/tree.css}">
    <link rel="stylesheet" th:href="@{/css/my-easyui-tree.css}">
    <link rel="stylesheet" th:href="@{/css/location.css}">
    <link rel="stylesheet" th:href="@{/css/regionPage.css}">
    <link rel="stylesheet" th:href="@{/css/map.css}">
    <!--百度地图-->
    <script type="text/javascript" src="https://api.map.baidu.com/api?type=webgl&v=1.0&ak=X4nK3H4asgsS4cuXSuvg0viGW9qPXDAQ"></script>
    <script type="text/javascript" th:src="@{/js/mapGL/GeoUtils/GeoUtils.js}"></script>
    <script type="text/javascript" th:src="@{/js/mapGL/DrawingManager/DrawingManager.js}"></script>
    <link rel="stylesheet" th:href="@{/js/mapGL/DrawingManager/DrawingManager.css}">
    <!--    <style>-->
    <!--        /*.tree-node:hover,.tree-node-selected ,.add_node_icon:hover,.edit_node_icon:hover,.del_node_icon:hover{!*鼠标悬浮*! !*鼠标点击选中*!*/-->
    <!--        /*    background: #ffffff00;!*背景透明*!*/-->
    <!--        /*    color: #00DBFF;!*字体颜色*!*/-->
    <!--        /*}*/-->
    <!--        ::-webkit-scrollbar {-->
    <!--            width: 0.1vw;-->
    <!--            height: 0.5vh;-->
    <!--        }-->
    <!--    </style>-->
    .layui-layer {
    top: 150px;
    left: 0;
    margin: 0;
    padding: 0;
    background-color: red !important;
    -webkit-background-clip: padding-box;
    border-radius: 2px;
    box-shadow: 1px 1px 50px rgba(0,0,0,.3);
    }
</head>
<body>
<div class="main-frame">
    <div id="container" class="map"></div>
    <div class="left-menu-frame">
        <div class="top-frame">
            <input class="search-input" id="area" placeholder="请输入区域名称(小区名称)">
            <button class="search-button" id="searchVillage">搜索</button>
            <button class="search-button">重置</button>
        </div>
        <div class="tree-frame">
            <ul id="organizeTree" ></ul>
        </div>

    </div>
    <div class="draw-button-block-1">
        <button class="draw-button" id="startDraw"  onclick="startDraw()">开始绘制</button>
        <button class="draw-button layui-hide" id="drawByEmpty" onclick="drawByEmpty()">从空白绘制</button>
        <button class="draw-button layui-hide" id="drawByUpLevel" onclick="drawByUpLevel()">从上一级切割</button>
        <button class="draw-button layui-hide" id="drawByOld" onclick="drawByOld()">从已有调整</button>

    </div>
    <div class="draw-button-block-2">
        <button class="draw-button layui-hide" id="endDraw"  onclick="endDraw()">回到起点</button>
        <button class="draw-button layui-hide" id="cancelUpPoint" style="" onclick="cancelUpPoint()">撤销上一点</button>
        <button class="draw-button layui-hide" id="clearDraw"  onclick="clearDraw()">取消绘制</button>
        <button class="draw-button layui-hide" id="saveDraw" onclick="saveDraw()">保存绘制</button>

    </div>
    <!--    <div style="width: 20vw;-->
    <!--    height: 98%;-->
    <!--    border-width: 0vh 0vh 0vh 0.1vh;-->
    <!--    border-color: #ffffff;-->
    <!--    border-style: solid;-->
    <!--    right: 0px;-->
    <!--    position: relative;-->
    <!--    overflow: scroll;-->
    <!--    padding: 1vh;-->
    <!--    float: right;-->
    <!--    display: inline-block;">-->

    <!--        <div style="width: 98%;height: 100%;/*top: 6vh;*/position: absolute;">-->

    <!--            <div class="row" style="color:#FFFFFF">-->

    <!--                <div class="col-sm-12">-->
    <!--                    地址: <input id="txtaddress" type="text" style="width:320px; margin-right:10px;" />&lt;!&ndash;<input type="button" value="查询" οnclick="theLocation()" />&ndash;&gt;-->
    <!--                    <p/>-->
    <!--                    经度: <input type="text" id="jd" style="width:320px; margin-right:10px;" />-->
    <!--                    <p/>-->
    <!--                    纬度: <input type="text" id="wd" style="width:320px; margin-right:10px;"/>-->
    <!--                    <p/>-->
    <!--                    <button id="btnAdd" type="button" >确认新增</button>-->
    <!--                </div>-->

    <!--                <div style="margin-top: 10px">-->
    <!--                    <button id="startDraw" style="width: 3vw;height: 100%;background: #00FFDB;margin-left: 0.2vw;border-radius: 0.1vw;border-width: 0px;" onclick="startDraw()">开始绘制</button>-->
    <!--                    <button class="layui-hide" id="endDraw" style="width: 3vw;height: 100%;background: #00FFDB;margin-left: 0.2vw;border-radius: 0.1vw;border-width: 0px;" onclick="endDraw()">结束绘制</button>-->
    <!--                    <button id="clearDraw" style="width: 3vw;height: 100%;background: #00FFDB;margin-left: 0.2vw;border-radius: 0.1vw;border-width: 0px;" onclick="clearDraw()">清空</button>-->
    <!--                    <button class="layui-hide" id="cancel" style="width: 3vw;height: 100%;background: #00FFDB;margin-left: 0.2vw;border-radius: 0.1vw;border-width: 0px;" onclick="cancel()">撤销</button>-->
    <!--                </div>-->
    <!--            </div>-->
    <!--        </div>-->

    <!--    </div>-->
</div>

</body>
<script>
    var layer = parent.layer;
    var checkedOrganizeId = -1;
    var checkedTreeLevel;
    var checkedNode;
    var checkedNodePoints = [];
    $(function () {
        initTree();
    })
    //树初始化
    function initTree(){
        $('#organizeTree').tree({
            url:'getOrganizeTree?pId=0',
            onLoadSuccess:function () { //当数据加载成功时触发
                var divs=document.getElementsByClassName("tree-node");
                for(var i =0; i<divs.length; i++){
                    var id = $(divs[i]).attr('id');
                    var html = $("#"+id+"").html();
                    html = html + '<div style="display: inline-flex;float: right;color: #ffffff; margin: 4px 0;">';
                    html = html + '<i class="layui-icon add_node_icon" name="addNode">&#xe654;</i>';/*新增*/
                    html = html + '<i class="layui-icon edit_node_icon" name="editNode">&#xe642;</i>';/*编辑*/
                    html = html + '<i class="layui-icon del_node_icon" name="delNode">&#xe640;</i>';/*删除*/
                    html = html + '</div>';
                    $("#"+id+"").html(html);
                }
                // $(".tree-node").css('display','inline-flex');
                iconClick();
            }
        });
    }
    var isIconClick = false;
    //树点击事件
    $('#organizeTree').tree({
        onClick:function (node) {
            console.log(node);
            checkedNode = node;
            checkedOrganizeId = node.id;
            checkedTreeLevel = node.iconCls;
            if(!isIconClick){//新增删除编辑时，不执行该操作 210923 hhp
                getDistrict(node.text,node.iconCls);
            }

        }
    });
    function iconClick() {
        //新增节点
        $(".add_node_icon").click(function () {
            console.info("click--->add");
            isIconClick = true;
            $(this).parent().parent().click();
            var selected = $('#organizeTree').tree('getSelected');
            console.info(selected)
            if(selected == null) {
                layer.msg('请先选择节点');
                return;
            }

            var iconCls = selected.iconCls;
            var level = Number(iconCls.substring(iconCls.length-1, iconCls.length));
            console.log(iconCls,level);


            layer.prompt({title:'请输入区域名称'},function(value, index, elem){
                console.log(value); //得到value
                layer.close(index);

                var data = {};
                data.text = value;
                data.iconCls = 'my-tree-icon-' + (level + 1);
                data.pId = selected.id;
                addTree(data,selected);
            });
            isIconClick = false;
        })
        $(".edit_node_icon").click(function (res) {
            console.info("click--->edit")
            isIconClick = true;
            $(this).parent().parent().click();
            var selected = $('#organizeTree').tree('getSelected');
            console.info(selected)
            if(selected == null) {
                layer.msg('请先选择节点');
                return;
            }
            var index = layer.prompt({title:'请输入区域名称'},function(value, index, elem){
                console.log(value); //得到value
                layer.close(index);

                var data = {};
                data.id = selected.id;
                data.text = value;
                data.iconCls = selected.iconCls;
                data.pId = selected.pId;
                $.post('modifyTree',data,function (res) {
                    console.log(res);
                    $('#organizeTree').tree('update', {
                        target: selected.target,
                        text: data.text
                    });
                })
            });
            $('#layui-layer'+index + " .layui-layer-input").val(selected.text);
            isIconClick = false;
        })
        $(".del_node_icon").click(function (res) {
            console.info("click--->del");
            isIconClick = true;
            $(this).parent().parent().click();
            var selected = $('#organizeTree').tree('getSelected');
            console.info(selected)
            if(selected == null) {
                layer.msg('请先选择节点');
                return;
            }
            layer.confirm('确定删除该节点？', function(index){

                if(selected.children.length>0){
                    layer.msg('请先删除该节点下的子节点');
                    return;
                }
                var loading = layer.load(1, {shade: [0.1,'#fff']});
                $.post('delTree',{id:selected.id},function (res) {
                    if (res.code > 0) {
                        layer.close(index);
                        $('#organizeTree').tree('remove',selected.target);
                    }
                    layer.msg(res.message);
                    layer.close(loading);
                })
            })
            isIconClick = false;
        })
    }


    //添加组织
    function addTree(data,node) {
        $.post('addTree',data,function (res) {
            initTree();
            villageLocation == null;
        })
    }
</script>


<script type="text/javascript">

    var map = new BMapGL.Map("container");

    var point = new BMapGL.Point(120.20769107795724, 30.183872266995300);//创建点坐标，不一定是点坐标，要看设置

    map.centerAndZoom(point,14);//设置中心点（确定中心点坐标）

    map.setTilt(30);       //设置地图的倾斜角度

    map.enableScrollWheelZoom(true);//在PC端可以通过滚轮放大缩小地图，移动端关闭该功能

    map.setMapStyleV2({
        styleId: '726af33cb58954d724aa45935732a562'//自定义地图样式 hhp
    });

    var i=0;
    var mapPoints = [

        {y:120.20769107795724, x:30.183872266995300, title:'公司', con:'这是远方中心',branch:"远方中心"}

    ];

    // 函数 创建多个标注
    function markerFun (points,label,infoWindows) {
        var markers = new BMapGL.Marker(points);
        markers.setIcon(myIcon)
        map.addOverlay(markers);
        markers.setLabel(label);
        markers.addEventListener("click",function (event) {

            map.openInfoWindow(infoWindows,points);//参数：窗口、点  根据点击的点出现对应的窗口
        });
    }
    for (; i<mapPoints.length; i++) {
        var points = new BMapGL.Point(mapPoints[i].y,mapPoints[i].x);//创建坐标点
        var opts = {
            width:250,
            height: 100,
            title:mapPoints[i].title
        };
        var label = new BMapGL.Label(mapPoints[i].branch,{
            offset:new BMapGL.Size(25,5),

        });
        var infoWindows = new BMapGL.InfoWindow(mapPoints[i].con,opts,{

        });
        label.setStyle({
            color : "#808080",
            borderColor: "#808080",
            backgroundColor:"#12223dff",
            fontSize : "12px",
            height : "20px",
            /*lineHeight : "20px",*/
            fontFamily:"微软雅黑",
            maxWidth:"none"
        });
        // markerFun(points,label,infoWindows);
    }

    // 查询区域信息
    var queryHouseOutline = function(hid, callback){
        var baseURL = 'http://map.baidu.com/?reqflag=pcmap&coord_type=3&from=weBMapGL&qt=ext&ext_ver=new&l=18';
        var url = baseURL + "&uid=" + hid;
        callback && (window.queryHouseOutlineCallback = callback);
        $.ajax({
            type: "get",
            async: false,
            url: url,
            dataType: "jsonp",
            jsonpCallback: "queryHouseOutlineCallback",
            success: function(datas) {
            }
        });
    };

    /**
     * 模糊查询小区信息, 无返回值
     * @param {} house	小区名称
     * @param {} city	所属城市名称
     * @param {} ak		百度地图AK
     * @param {} callback	回调函数，该函数可以接收到请求的返回值
     */
    var queryHouse = function(house, city, ak, callback){
        var baseURL = 'http://api.map.baidu.com/place/v2/search?';
        var url = baseURL + "&query=" + house + "&region=" + city + "&output=json&ak=" + ak;

        //console.log(url)
        callback && (window.queryHouseCallback = callback);
        $.ajax({
            type: "get",
            async: false,
            url: url,
            dataType: "jsonp",
            jsonpCallback: "queryHouseCallback",
            success: function(datas) {
            }
        });
    };

    /**
     * 墨卡托坐标转百度坐标 baidu jsapi WebGL 版本使用
     * @param {} coordinate
     * @return {}
     */
    var coordinateToPoints = function(map, coordinate) {
        var points = [];
        if (coordinate) {
            var arr = coordinate.split(";");
            if(arr){
                for(var i = 0; i < arr.length; i++){

                    var coord = arr[i].split(",");
                    if(coord && coord.length == 2){
                        var lngLat = map.mercatorToLnglat(coord[0], coord[1]);
                        //console.log(lngLat)
                        //var point = project.pointToLngLat(mctXY);
                        points.push(new BMapGL.Point(lngLat[0], lngLat[1]));
                    }
                }
            }
        }
        return points;
    };
    // js版本使用
    // var coordinateToPoints = function(map, coordinate) {
    //     var points = [];
    //     if (coordinate) {
    //         var arr = coordinate.split(";");
    //         if(arr){
    //             for(var i = 0; i < arr.length; i++){
    //                 var coord = arr[i].split(",");
    //                 if(coord && coord.length == 2){
    //                     var mctXY = new BMapGL.Pixel(coord[0], coord[1]);
    //                     var project = map.getMapType().getProjection();
    //                     var point = project.pointToLngLat(mctXY);
    //                     points.push(new BMapGL.Point(point.lng, point.lat));
    //                 }
    //             }
    //         }
    //     }
    //     return points;
    // };
    /**
     * 墨卡托坐标解析
     * @param {} mocator
     * @return {}
     */
    var parseGeo = function(mocator){
        if(typeof mocator != 'string'){
            return {};
        }
        var t = mocator.split("|");
        var n = parseInt(t[0]);
        var i = t[1];
        var r = t[2];
        var o = r.split(";");
        if(n === 4){
            for (var a = [], s = 0; s < o.length - 1; s++){
                "1" === o[s].split("-")[0] && a.push(o[s].split("-")[1]);
            }
            o = a;
            o.push("");
        }
        var u = [];
        switch(n){
            case 1:
                u.push(o[0]);
                break;
            case 2:
            case 3:
            case 4:
                for (var s = 0; s < o.length - 1; s++) {
                    var l = o[s];
                    if (l.length > 100){
                        l = l.replace(/(-?[1-9]\d*\.\d*|-?0\.\d*[1-9]\d*|-?0?\.0+|0|-?[1-9]\d*),(-?[1-9]\d*\.\d*|-?0\.\d*[1-9]\d*|-?0?\.0+|0|-?[1-9]\d*)(,)/g,
                            "$1,$2;");
                        u.push(l);
                    } else {
                        for (var c = [], d = l.split(","), f = 0; f < d.length; f += 2) {
                            var p = d[f];
                            var h = d[f + 1];
                            c.push(p + "," + h);
                        }
                        u.push(c.join(";"))
                    }
                }
                break;
            default:
                break;
        }

        if(u.length <= 1){
            u = u.toString();
        }

        var result = {
            type : n,
            bound : i,
            points : u
        };
        return result;
    };
    var tempPly;

    // 搜索到的小区的位置信息
    var villageLocation = null;

    /**
     * 第一个参数是城市名，第二参数是小区名
     */
    var showArea = function(city, area){
        queryHouse(area, city, "GFoKC0MaH0l4iCj6bNKZedu5fCPkEXWe", function(data){
            console.log(data)
            if (data.message == 'ok'){
                var houses = data.results;
                if(houses && houses.length > 0){
                    var house = houses[0];

                    queryHouseOutline(house.uid, function(houseOutline){

                        //console.log(houseOutline)
                        var geo = houseOutline.content.geo;
                        var location = house.location;

                        var point = new BMapGL.Point(location.lng, location.lat);

                        var marker = new BMapGL.Marker(point);
                        var label = new BMapGL.Label(area,{
                            offset:new BMapGL.Size(0,0),

                        });
                        marker.setLabel(label);
                        map.addOverlay(marker);

                        if(!geo){
                            // 20210922 Wangchong 未搜到的信息进行手动绘制
                            layer.msg("未搜索到信息,请手动选择小区!");
                        }else{
                            // map.remove;
                            villageLocation = location;
                            // $("#jd").val(location.lng);
                            // $("#wd").val(location.lat);
                            $("#txtaddress").val(house.address)
                            var geoObj = parseGeo(geo);
                            //var bounds = coordinateToPoints(geoObj.bound);
                            //边界点
                            var points = coordinateToPoints(map, geoObj.points);
                            var prism = new BMapGL.Prism(points, 100, {
                                topFillColor: '#064360',
                                topFillOpacity: 0.5,
                                sideFillColor: '#188C8E',
                                sideFillOpacity: 0.8
                            });
                            tempPly = prism;
                            map.addOverlay(prism); //添加覆盖物
                            map.setTilt(60);
                            // map.setViewport(prism.getPath()); //调整视野
                        }
                    });
                }
            }
        });
    };

    //  搜索按钮点击
    $("#searchVillage").click(function () {
        var villageName = $("#area").val();
        if (villageName == ""){
            return;
        }
        showArea("杭州市", villageName);
    })

    // 添加小区区域信息
    $("#btnAdd").click(function(){
        var villageName = $("#area").val();
        if (villageName == ""){
            return;
        }
        if (villageLocation == null){
            layer.msg("请搜索小区或者手动绘制!");
            return;
        }

        var node = $('#organizeTree').tree('getSelected');
        if (node == null){
            layer.msg("请选择区域节点!");
            return;
        }

        if (node.iconCls != "my-tree-icon-5"){
            layer.msg("请选择社区级的节点!");
            return;
        }

        var orgInfo = {};
        orgInfo.organizeName = villageName;
        orgInfo.pId = node.id;
        // 小区
        orgInfo.nodeLevel = "my-tree-icon-6";
        orgInfo.longitude = villageLocation.lng;
        orgInfo.latitude = villageLocation.lat;

        $.ajax({
            url : 'insertOrganize',
            type:'post',
            contentType:'application/json;charset=utf-8',
            data:JSON.stringify(orgInfo),
            success:function (res) {
                if (res.code > 0){
                    layer.msg("添加成功!");
                    initTree();
                }else {
                    layer.msg("添加失败!");
                    console.log(msg);
                }
            }
        })
    })

    /**
     * 添加小区
     */
    function addVillage(){
        var node = $('#organizeTree').tree('getSelected');
        if (node){
            var nodes = [{
                "id":13,
                "text":"Raspberry"
            },{
                "id":14,
                "text":"Cantaloupe"
            }];
            $('#organizeTree').tree('append', {
                parent:node.target,
                data:nodes
            });
        }
    }

    // function getBoundary(){
    //
    //     var bdary = new BMapGL.Boundary();
    //
    //     // var name = document.getElementById("districtName").value;
    //
    //     bdary.get('浙江省', function(rs){       //获取行政区域
    //
    //         map.clearOverlays();        //清除地图覆盖物
    //
    //         var count = rs.boundaries.length; //行政区域的点有多少个
    //
    //         for(var i = 0; i < count; i++){
    //
    //             var ply = new BMapGL.Polygon(rs.boundaries[i], {strokeWeight: 2, strokeColor: "#ff0000"}); //建立多边形覆盖物
    //
    //             // console.log("当前辖区坐标：" + name);
    //             // console.log(rs.boundaries[i]);
    //
    //             map.addOverlay(ply);  //添加覆盖物
    //
    //             map.setViewport(ply.getPath());    //调整视野
    //
    //         }
    //
    //     });
    //
    // }
    //getBoundary();
    // 获取行政区域
    var boundary = new BMapGL.Boundary()
    //点击组织树 框选区域以及自动缩放地图大小
    function getDistrict(district,iconCls) {
        checkedNodePoints = [];
        var prism;
        var threeDHight = 200;//3D棱柱高度
        var mapLevel = 13;//地图缩放大小
        var time = 1000; //旋转地图角度等待时间
        var topFillColor = '#003399';
        var sideFillColor = '#062070';
        if(checkedTreeLevel == 'my-tree-icon-6'){
            topFillColor = '#0055ff';
            sideFillColor = '#062c9b';
        }
        switch (iconCls) {
            case 'my-tree-icon-1':
                threeDHight = 50000;
                mapLevel = 8;
                time = 3000;
                break;
            case 'my-tree-icon-2':
                threeDHight = 10000;
                mapLevel = 10;
                break;
            case 'my-tree-icon-3':
                threeDHight = 2000;
                mapLevel = 13;
                break;
            case 'my-tree-icon-4':
                threeDHight = 1000;
                mapLevel = 14;
                break;
            case 'my-tree-icon-5':
                threeDHight = 200;
                mapLevel = 16;
                break;
            case 'my-tree-icon-6':
                threeDHight = 200;
                mapLevel = 17.9;
                break;
            default:
                break;
        }

        // if(district.indexOf('省') > -1){
        //     threeDHight = 5000;
        //     mapLevel = 8;
        // }
        // if(district.indexOf('市') > -1){
        //     threeDHight = 1000;
        //     mapLevel = 10;
        // }
        // if(district.indexOf('区') > -1 || district.indexOf('县') > -1){
        //     threeDHight = 200;
        //     mapLevel = 13;
        // }
        // if(district.indexOf('街道') > -1){
        //     threeDHight = 200;
        //     mapLevel = 15;
        // }
        // if(district.indexOf('社区') > -1){
        //     threeDHight = 200;
        //     mapLevel = 17;
        // }
        // if(district.indexOf('小区') > -1){
        //     threeDHight = 200;
        //     mapLevel = 19;
        // }
        var centerPoint ;
        var houses;
        map.clearOverlays();//清空覆盖物
        var points = [];
        $.post('getRegionData',{organizeId:checkedOrganizeId},function (res) {
            if(res.length > 0){

                $.each(res,function (index,item) {
                    var point = new BMapGL.Point(item.longitude,item.latitude);
                    points.push(point);
                });
                console.info("---->points");
                console.info(points);
                //计算中心点 start
                centerPoint = getCenterPoint(points);
                //end
                var marker = new BMapGL.Marker(centerPoint);
                var label = new BMapGL.Label(district,{
                    offset:new BMapGL.Size(0,0),

                });
                marker.setLabel(label);
                map.addOverlay(marker);
                map.centerAndZoom(centerPoint,mapLevel);//设置中心点以及地图大小
                window.setTimeout(function (){
                    map.setTilt(60);//改变地图倾斜角度
                },time);

                var prism2 = new BMapGL.Prism(points, threeDHight, {
                    topFillColor: topFillColor,
                    topFillOpacity: 0.4,
                    sideFillColor: sideFillColor,
                    sideFillOpacity: 0.2,
                    enableMassClear: true
                });
                console.info(points);
                map.addOverlay(prism2); //添加覆盖物
                prismGroup.push(prism2);
                $.each(points,function (index,point) {
                    checkedNodePoints.push(point);
                });
            }else{
                queryHouse(district, '浙江省', "GFoKC0MaH0l4iCj6bNKZedu5fCPkEXWe", function(data) {
                    console.log(data)
                    if (data.message == 'ok') {
                        houses = data.results;
                        if(houses.length > 0){
                            var location = data.results[0].location;
                            centerPoint = new BMapGL.Point(location.lng, location.lat);
                            var marker = new BMapGL.Marker(centerPoint);
                            var label = new BMapGL.Label(district,{
                                offset:new BMapGL.Size(0,0),

                            });
                            marker.setLabel(label);
                            map.addOverlay(marker);
                            console.info("mapLevel="+mapLevel);

                            map.centerAndZoom(centerPoint,mapLevel);//设置中心点以及地图大小
                            window.setTimeout(function (){
                                map.setTilt(60);//改变地图倾斜角度
                            },time);

                            console.info(iconCls)
                            if(iconCls == 'my-tree-icon-6'){
                                console.info(houses)
                                if(houses && houses.length > 0){
                                    var house = houses[0];
                                    queryHouseOutline(house.uid, function(houseOutline){
                                        console.log(houseOutline)
                                        var geo = houseOutline.content.geo;

                                        if(geo){
                                            villageLocation = location;
                                            var geoObj = parseGeo(geo);
                                            //边界点
                                            points = coordinateToPoints(map, geoObj.points);
                                            var prism = new BMapGL.Prism(points, threeDHight, {
                                                topFillColor: topFillColor,
                                                topFillOpacity: 0.4,
                                                sideFillColor: sideFillColor,
                                                sideFillOpacity: 0.2,
                                                enableMassClear: true
                                            });
                                            map.addOverlay(prism); //添加覆盖物
                                            $.each(points,function (index,point) {
                                                checkedNodePoints.push(point);
                                            });

                                            // map.setTilt(60);
                                            // map.setViewport(prism.getPath()); //调整视野
                                        }
                                    });
                                }
                            }else{
                                // map.setTilt(30);
                                boundary.get(district, function (data) {
                                    console.log(data)
                                    for(var j= 0; j <data.boundaries.length; j++){
                                        var boundaries = data.boundaries[j].split(";");

                                        var locationStr;
                                        for (var i = 0; i < boundaries.length; i++) {
                                            locationStr = boundaries[i];
                                            var point = new BMapGL.Point(locationStr.substring(0, locationStr.indexOf(",")), locationStr.substring(locationStr.indexOf(",") + 1));//创建点坐标，不一定是点坐标，要看设置
                                            points[i] = point;
                                        }
                                    }

                                    prism = new BMapGL.Prism(points, threeDHight, {
                                        topFillColor: topFillColor,
                                        topFillOpacity: 0.4,
                                        sideFillColor: sideFillColor,
                                        sideFillOpacity: 0.2,
                                        enableMassClear: true
                                    });
                                    map.addOverlay(prism); //添加覆盖物
                                    prismGroup.push(prism);

                                    $.each(points,function (index,point) {
                                        checkedNodePoints.push(point);
                                    });
                                    // map.setViewport(prism.getPath()); //调整视野
                                    console.info("end")
                                });
                            }
                        }
                    }
                });
            }

        });

    }

    // getDistrict("杭州市");


    //hhp add------------------------------------------------------
    //点击返回
    var geoc = new BMapGL.Geocoder();
    map.addEventListener("click", function (e) {
        var pt = e.latlng;//获取点击的坐标点
        console.info("点击 click_map");
        console.info(e)
        // var wd = document.getElementById('wd');
        // var jd = document.getElementById('jd');
        // var address = document.getElementById("txtaddress");
        //返回坐标
        // jd.value = pt.lng;
        // wd.value = pt.lat;
        //点击坐标返回地址
        // geoc.getLocation(pt, function (rs) {
        //     console.info(rs)
        //     var addComp = rs.addressComponents;
        //     var addresstext = "";
        //     if (addComp.province == addComp.city) {
        //         addresstext = (addComp.province + addComp.district + addComp.street + addComp.streetNumber);
        //     }
        //     else {
        //         addresstext = (addComp.province + addComp.city + addComp.district +addComp.street + addComp.streetNumber);
        //     }
        //     address.value = addresstext;
        // });

        if(drawState){
            //画点
            var pointIcon = new BMapGL.Icon("../image/map_point_icon/icon_point_red.png",new BMapGL.Size(8,8))
            var point = new BMapGL.Point(pt.lng,pt.lat);
            regionPointGroup.push(point);
            var marker = new BMapGL.Marker(point,{icon: pointIcon});//创建标注

            $("#cancelUpPoint").removeClass('layui-hide');
            // marker[regionPointGroup.length] = new BMapGL.Marker(point,{icon: pointIcon});// 创建标注
            // map.addOverlay(marker[regionPointGroup.length]); // 将标注添加到地图中
            // markerGroup.push(marker[regionPointGroup.length]);
            $("#saveDraw").removeClass('layui-hide');
            map.addOverlay(marker); // 将标注添加到地图中
            markerGroup.push(marker);
            if(regionPointGroup.length > 1){
                //画线
                var trackPoint = [];
                trackPoint.push(regionPointGroup[regionPointGroup.length-2]);
                trackPoint.push(regionPointGroup[regionPointGroup.length-1]);
                var polyline = new BMapGL.Polyline(trackPoint, {
                    strokeColor: "#18ff06",
                    strokeWeight: 3,
                    setStrokeStyle:"dashed",
                    strokeOpacity: 1
                });
                map.addOverlay(polyline);
                lineGroup.push(polyline);
            }
            if(regionPointGroup.length > 2){
                $("#endDraw").removeClass('layui-hide');
            }
            if(isDrawByUpPoint){
                if(BMapGLLib.GeoUtils.isPointInPolygon(point,lineGroup[0])){
                    console.info("在范围内");
                }else{
                    console.info("不在范围内");
                }
            }
        }

    });

    var regionPointGroup = [];
    var markerGroup = [];
    var lineGroup = [];
    var prismGroup = [];
    var drawState = false; //是否允许在地图上绘制点
    var isDrawByOld = false; //是否从已有区域范围上调整
    var isDrawByUpPoint = false; //是否从上一级进行绘制
    /**
     * 开始绘制
     */
    function startDraw(){
        var selected = $('#organizeTree').tree('getSelected');
        console.info(selected)
        if(selected == null) {
            layer.msg('请先选择节点');
            return;
        }
        map.clearOverlays();//清空覆盖物
        $("#startDraw").addClass('layui-hide');
        $("#drawByEmpty").removeClass('layui-hide');
        $("#drawByUpLevel").removeClass('layui-hide');
        $("#drawByOld").removeClass('layui-hide');
        $("#clearDraw").removeClass('layui-hide');


        console.info("开始绘制");
        regionPointGroup = [];
        markerGroup = [];
        lineGroup = [];
        prismGroup = [];
    }

    /**
     * 回到起点
     */
    function endDraw(){

        // $("#drawByEmpty").addClass('layui-hide');
        $("#drawByUpLevel").addClass('layui-hide');
        $("#drawByOld").addClass('layui-hide');
        $("#cancelUpPoint").addClass('layui-hide');
        $("#endDraw").addClass('layui-hide');

        console.info("结束绘制");
        drawState = false;
        regionPointGroup.push(regionPointGroup[0]);//回到起点
        map.clearOverlays();//清空覆盖物
        //画线
        // var trackPoint = [];
        // trackPoint.push(regionPointGroup[regionPointGroup.length-2]);
        // trackPoint.push(regionPointGroup[regionPointGroup.length-1]);
        var polyline = new BMapGL.Polyline(regionPointGroup, {
            strokeColor: "#18ff06",
            strokeWeight: 3,
            setStrokeStyle:"dashed",
            strokeOpacity: 1
        });
        lineGroup = [];
        map.addOverlay(polyline);
        lineGroup.push(polyline);
        //3D棱柱绘制
        if(regionPointGroup.length > 2){
            var prism = new BMapGL.Prism(regionPointGroup, 500, {
                topFillColor: '#5679ea',
                topFillOpacity: 0.6,
                sideFillColor: '#5679ea',
                sideFillOpacity: 0.9
            });
            map.addOverlay(prism);
            prismGroup.push(prism);
        }
        //清空点
        // for(var i=0; i<markerGroup.length; i++){
        //     map.removeOverlay(markerGroup[i]);
        // }
        // markerGroup = [];
    }

    /**
     * 取消绘制
     */
    function clearDraw() {
        $("#startDraw").removeClass('layui-hide');
        $("#clearDraw").addClass('layui-hide');
        $("#saveDraw").addClass('layui-hide');
        $("#cancelUpPoint").addClass('layui-hide');
        $("#endDraw").addClass('layui-hide');
        $("#drawByUpLevel").addClass('layui-hide');
        $("#drawByOld").addClass('layui-hide');
        console.info("请空")
        console.info("点集合长度:"+markerGroup.length)

        map.clearOverlays();//清空覆盖物
        regionPointGroup = [];
        markerGroup = [];
        lineGroup = [];
        prismGroup = [];

        //清空点
        // for(var i=0; i<markerGroup.length; i++){
        //     map.removeOverlay(markerGroup[i]);
        // }
        // regionPointGroup = [];
        // markerGroup = [];
        // //清空线
        // console.info("线集合长度:"+lineGroup.length)
        // for(var i=0; i<lineGroup.length; i++){
        //     map.removeOverlay(lineGroup[i]);
        // }
        //
        // lineGroup = [];
        // //清空3D棱柱
        // console.info("柱集合长度:"+prismGroup.length)
        // for(var i=0; i<prismGroup.length; i++){
        //     map.removeOverlay(prismGroup[i]);
        // }
        // prismGroup = [];
    }
    /**
     * 撤销上一个点
     */
    function cancelUpPoint() {
        //撤销上一步动作
        console.info("撤销")
        console.info("点集合长度:"+markerGroup.length)
        // if(markerGroup.length > 0){
        //     map.removeOverlay(markerGroup[markerGroup.length-1]);
        //     markerGroup.splice(markerGroup.length-1,1);
        //     if(regionPointGroup.length > 0){
        //         regionPointGroup.splice(regionPointGroup.length-1,1)
        //     }
        // }
        if(regionPointGroup.length > 0){
            map.removeOverlay(regionPointGroup[regionPointGroup.length-1]);
            regionPointGroup.splice(regionPointGroup.length-1,1)
        }
        console.info("线集合长度:"+lineGroup.length)
        if(lineGroup.length > 0){
            map.removeOverlay(lineGroup[lineGroup.length-1]);
            lineGroup.splice(lineGroup.length-1,1);
        }
    }
    /**
     *保存绘制
     */
    function saveDraw(){
        drawState = false;
        $("#startDraw").removeClass('layui-hide');

        $("#clearDraw").addClass('layui-hide');
        $("#saveDraw").addClass('layui-hide');
        $("#drawByOld").addClass('layui-hide');
        $("#drawByUpLevel").addClass('layui-hide');

        var datas = new Array();;

        if(isDrawByOld){
            var pts=lineGroup[0].getPath();
            console.info(pts);
            $.each(pts,function (index,item) {
                markerGroup.push(pts[index]);
            });
            markerGroup.splice(markerGroup.length-1,1);//去掉最后一个点，即起点
            $.each(markerGroup,function (index,item) {
                var latitude = item.lat;
                var longitude = item.lng;
                var data = {};
                data.organizeId = checkedOrganizeId;
                data.longitude = longitude;
                data.latitude = latitude;
                datas.push(data);
            });
        }else{
            $.each(markerGroup,function (index,item) {
                var latitude = item.latLng.lat;
                var longitude = item.latLng.lng;
                var data = {};
                data.organizeId = checkedOrganizeId;
                data.longitude = longitude;
                data.latitude = latitude;
                datas.push(data);
            });
        }
        console.info(markerGroup)

        markerGroup = [];
        console.info(datas);
        $.ajax({
            url: "insertOrganizeRegionList",
            type: 'post',
            contentType: 'application/json;charset=utf-8',
            data: JSON.stringify(datas),
            success: function (res) {
                console.info("新增区域点位----》");
                console.info(res)
                layer.msg(res.message);
            }
        })
        // $.post('insertOrganizeRegionList',datas,function (res) {
        //     console.info("新增区域点位----》");
        //     console.info(res)
        // })

    }

    /**
     * 从空白绘制
     */
    function drawByEmpty() {
        drawState = true;
        isDrawByOld = false;
        isDrawByUpPoint = false;
        $("#drawByEmpty").addClass('checked');
        $("#drawByUpLevel").removeClass('checked');
        $("#drawByOld").removeClass('checked');
        $("#endDraw").removeClass('layui-hide');
        $("#cancelUpPoint").removeClass('layui-hide');

        map.clearOverlays();//清空覆盖物
        regionPointGroup = [];
        markerGroup = [];
        lineGroup = [];
        prismGroup = [];
    }

    /**
     * 从上一级切割
     */
    function drawByUpLevel() {

        drawState = true;
        isDrawByOld = false;
        isDrawByUpPoint = true;
        $("#drawByEmpty").removeClass('checked');
        $("#drawByUpLevel").addClass('checked');
        $("#drawByOld").removeClass('checked');

        map.clearOverlays();//清空覆盖物
        regionPointGroup = [];
        markerGroup = [];
        lineGroup = [];
        prismGroup = [];

        var parentNode = $('#organizeTree').tree('getParent',checkedNode.target);
        console.info(parentNode)
        getRegion(parentNode.text,parentNode.id,parentNode.iconCls,function (data) {
            console.info(data.points);
            data.points.push(data.points[0]);
            var polygon = new BMapGL.Polygon(data.points,
                {strokeColor:"#f50704",fillColor:"#cfcfcf", strokeWeight:5, strokeOpacity:1,fillOpacity:0,});
            map.addOverlay(polygon);
            lineGroup.push(polygon);

            // var polyline = new BMapGL.Polyline(data.points, {
            //     strokeColor: "#fffa00",
            //     strokeWeight: 3,
            //     setStrokeStyle:"dashed",
            //     strokeOpacity: 1
            // });
            // map.addOverlay(polyline);
            // lineGroup.push(polyline);
        });

    }

    /**
     * 从已有调整
     */
    function drawByOld() {
        map.clearOverlays();//清空覆盖物
        regionPointGroup = [];
        markerGroup = [];
        lineGroup = [];
        prismGroup = [];
        drawState = false;
        isDrawByOld = true;
        isDrawByUpPoint = false;
        $("#drawByEmpty").removeClass('checked');
        $("#drawByUpLevel").removeClass('checked');
        $("#drawByOld").addClass('checked');

        $("#cancelUpPoint").addClass('layui-hide');
        $("#endDraw").addClass('layui-hide');
        $("#saveDraw").removeClass('layui-hide');
        checkedNodePoints.push(checkedNodePoints[0]);
        var polyline = new BMapGL.Polyline(checkedNodePoints, {
            strokeColor: "#18ff06",
            strokeWeight: 3,
            setStrokeStyle:"dashed",
            strokeOpacity: 1
        });
        map.addOverlay(polyline);
        lineGroup.push(polyline);
        polyline.enableEditing();
    }


</script>


<script>
    /*计算不规则多边形中心点*/
    function getCenterPoint(points) {
        var minLng;
        var maxLng;
        var minLat;
        var maxLat;
        $.each(points,function (index,item) {
            if(index == 0){
                minLng = item.lng;
                maxLng = item.lng;
                minLat = item.lat;
                maxLat = item.lat;
            }
            if(minLng > item.lng){
                minLng = item.lng;
            }
            if(maxLng < item.lng){
                maxLng = item.lng;
            }
            if(minLat > item.lat){
                minLat = item.lat;
            }
            if(maxLat < item.lat){
                maxLat = item.lat;
            }
        })
        var centerLng = (minLng + maxLng)/2;
        var centerLat = (minLat + maxLat)/2;
        return new BMapGL.Point(centerLng,centerLat);
    }

    /**
     *
     * @param district 区域名称
     * @param iconCls Tree节点等级
     */
    function getRegion(district,organizeId,iconCls,callback) {
        // checkedNodePoints = [];
        var prism;
        var threeDHight = 200;//3D棱柱高度
        var mapLevel = 13;//地图缩放大小
        var time = 1000; //旋转地图角度等待时间
        var topFillColor = '#003399';
        var sideFillColor = '#062070';
        if(checkedTreeLevel == 'my-tree-icon-6'){
            topFillColor = '#0055ff';
            sideFillColor = '#062c9b';
        }
        switch (iconCls) {
            case 'my-tree-icon-1':
                threeDHight = 50000;
                mapLevel = 8;
                time = 3000;
                break;
            case 'my-tree-icon-2':
                threeDHight = 10000;
                mapLevel = 10;
                break;
            case 'my-tree-icon-3':
                threeDHight = 2000;
                mapLevel = 13;
                break;
            case 'my-tree-icon-4':
                threeDHight = 1000;
                mapLevel = 14;
                break;
            case 'my-tree-icon-5':
                threeDHight = 200;
                mapLevel = 16;
                break;
            case 'my-tree-icon-6':
                threeDHight = 200;
                mapLevel = 17.9;
                break;
            default:
                break;
        }

        var centerPoint ;
        var houses;
        map.clearOverlays();//清空覆盖物
        var points = [];
        $.post('getRegionData',{organizeId:organizeId},function (res) {
            if(res.length > 0){
                $.each(res,function (index,item) {
                    var point = new BMapGL.Point(item.longitude,item.latitude);
                    points.push(point);
                });
                // //计算中心点 start
                // centerPoint = getCenterPoint(points);
                // //end
                // var marker = new BMapGL.Marker(centerPoint);
                // var label = new BMapGL.Label(district,{
                //     offset:new BMapGL.Size(0,0),
                //
                // });
                // marker.setLabel(label);
                // map.addOverlay(marker);
                // map.centerAndZoom(centerPoint,mapLevel);//设置中心点以及地图大小
                // window.setTimeout(function (){
                //     map.setTilt(60);//改变地图倾斜角度
                // },time);
                //
                // var prism2 = new BMapGL.Prism(points, threeDHight, {
                //     topFillColor: topFillColor,
                //     topFillOpacity: 0.4,
                //     sideFillColor: sideFillColor,
                //     sideFillOpacity: 0.2,
                //     enableMassClear: true
                // });
                // console.info(points);
                // map.addOverlay(prism2); //添加覆盖物
                // prismGroup.push(prism2);
                callback({
                    points: points
                });
            }else{
                queryHouse(district, '浙江省', "GFoKC0MaH0l4iCj6bNKZedu5fCPkEXWe", function(data) {
                    console.log(data)
                    if (data.message == 'ok') {
                        houses = data.results;
                        if(houses.length > 0){
                            var location = data.results[0].location;
                            // centerPoint = new BMapGL.Point(location.lng, location.lat);
                            // var marker = new BMapGL.Marker(centerPoint);
                            // var label = new BMapGL.Label(district,{
                            //     offset:new BMapGL.Size(0,0),
                            //
                            // });
                            // marker.setLabel(label);
                            // map.addOverlay(marker);
                            // console.info("mapLevel="+mapLevel);
                            //
                            // map.centerAndZoom(centerPoint,mapLevel);//设置中心点以及地图大小
                            window.setTimeout(function (){
                                map.setTilt(60);//改变地图倾斜角度
                            },time);

                            console.info(iconCls)
                            if(iconCls == 'my-tree-icon-6'){
                                console.info(houses)
                                if(houses && houses.length > 0){
                                    var house = houses[0];
                                    queryHouseOutline(house.uid, function(houseOutline){
                                        console.log(houseOutline)
                                        var geo = houseOutline.content.geo;

                                        if(geo){
                                            villageLocation = location;
                                            var geoObj = parseGeo(geo);
                                            //边界点
                                            points = coordinateToPoints(map, geoObj.points);
                                            // var prism = new BMapGL.Prism(points, threeDHight, {
                                            //     topFillColor: topFillColor,
                                            //     topFillOpacity: 0.4,
                                            //     sideFillColor: sideFillColor,
                                            //     sideFillOpacity: 0.2,
                                            //     enableMassClear: true
                                            // });
                                            // map.addOverlay(prism); //添加覆盖物
                                            callback({
                                                points: points
                                            });
                                            // map.setTilt(60);
                                            // map.setViewport(prism.getPath()); //调整视野
                                        }
                                    });
                                }
                            }else{
                                // map.setTilt(30);
                                boundary.get(district, function (data) {
                                    console.log(data)
                                    for(var j= 0; j <data.boundaries.length; j++){
                                        var boundaries = data.boundaries[j].split(";");

                                        var locationStr;
                                        for (var i = 0; i < boundaries.length; i++) {
                                            locationStr = boundaries[i];
                                            var point = new BMapGL.Point(locationStr.substring(0, locationStr.indexOf(",")), locationStr.substring(locationStr.indexOf(",") + 1));//创建点坐标，不一定是点坐标，要看设置
                                            points[i] = point;
                                        }
                                    }

                                    // prism = new BMapGL.Prism(points, threeDHight, {
                                    //     topFillColor: topFillColor,
                                    //     topFillOpacity: 0.4,
                                    //     sideFillColor: sideFillColor,
                                    //     sideFillOpacity: 0.2,
                                    //     enableMassClear: true
                                    // });
                                    // map.addOverlay(prism); //添加覆盖物
                                    // prismGroup.push(prism);

                                    callback({
                                        points: points
                                    });
                                    // map.setViewport(prism.getPath()); //调整视野
                                });
                            }
                        }
                    }
                });
            }

        });

    }

</script>
</html>